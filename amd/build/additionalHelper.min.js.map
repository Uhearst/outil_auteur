{"version":3,"file":"additionalHelper.min.js","sources":["../src/additionalHelper.js"],"sourcesContent":["import {validateAdditionalInfo} from \"./validator/addtionnalInformationValidator\";\nimport {get_string as getString} from 'core/str';\nimport {\n    buildHiddenInput,\n    initEditor,\n    removeTinyEditor,\n    setDeleteButton,\n    setEditorAfterCloning\n} from \"./utils\";\nimport {handleAccordions, handleNewAccordion, initAccordionsAfterFillingForm} from \"./accordionHandler\";\n\nlet counterInfo = 0;\n\n/**\n *\n */\nexport function initAdditional() {\n    const formContainer = document.getElementById('form_container');\n    formContainer.addEventListener('click', async event => {\n        const isButton = event.target.nodeName === 'BUTTON'\n            || (event.target.nodeName === 'I' && event.target.parentNode && event.target.parentNode.nodeName === 'BUTTON');\n        if (!isButton) {\n            return;\n        } else {\n            let element = null;\n            if (event.target.nodeName === 'I') {\n                element = event.target.parentNode;\n            } else {\n                element = event.target;\n            }\n            if (element && element.id.includes('add_info') && element.hidden === false) {\n                if (element.id.includes('remove')) {\n                    let id = element.id.substring(element.id.lastIndexOf('_') + 1);\n                    await removeAdditionalInfo(id);\n                    disableAddInfoDeleteButton();\n                    await updateExistingHeaders();\n                    document.getElementById('udeh-form').dataset.changed = 'true';\n                    event.stopImmediatePropagation();\n                }\n            } else {\n                return;\n            }\n        }\n    });\n\n    let addButton = document.querySelector('#id_add_info');\n    addButton.addEventListener('click', async event => {\n        event.stopImmediatePropagation();\n        let element = event.target;\n\n        if (element && element.hidden === false) {\n            await addAdditionalInfo(true);\n            document.getElementById('udeh-form').dataset.changed = 'true';\n            disableAddInfoDeleteButton();\n        } else {\n            return;\n        }\n\n    });\n    validateAdditionalInfo();\n}\n\n/**\n * @param {array} informations\n */\nexport const fillFormAdditional = async(informations) => {\n    if (informations && informations.length > 0) {\n        for (const information of informations) {\n            const i = informations.indexOf(information);\n            if (i === 0) {\n                buildHiddenInput(information.id, i, 'fitem_id_add_info_title_' + (i), 'add_info_');\n                document.querySelector('[name = \"add_info_0_id_value\"]').setAttribute('value', information.id);\n            } else {\n                if (document.getElementById('id_add_info_title_' + i) === null) {\n                    await addAdditionalInfo(false);\n                }\n                document.querySelector('#id_add_info_title_' + i).value = information.title;\n                document.querySelector('#id_add_info_content_' + i).value = information.content;\n                document.querySelector('[name = \"add_info_' + i + '_id_value\"]').setAttribute('value', information.id);\n                await handleEditor(i);\n            }\n        }\n    }\n    disableAddInfoDeleteButton();\n    initAccordionsAfterFillingForm();\n    handleAccordions();\n};\n\n/**\n * @param {integer} index\n */\nasync function removeAdditionalInfo(index) {\n    await removeTinyEditor('id_add_info_content_' + index);\n    document.querySelector('#add_info_' + index).remove();\n    document.getElementById('udeh-form').dataset.changed = 'true';\n}\n\nconst updateExistingHeaders = async () => {\n    let headers = document.querySelectorAll('[aria-controls^=\"collapse_addinfo_header_\"]');\n    headers = Array.from(headers);\n    for (const header of headers) {\n        const i = headers.indexOf(header);\n        header.innerText = await getString('field', 'format_udehauthoring') + ' ' + (i + 1);\n    }\n};\n\nconst disableAddInfoDeleteButton = () => {\n    let infos = document.querySelectorAll('[id^=\"add_info_\"]');\n    if (infos.length <= 1) {\n        let button = document.querySelector('[id^=\"id_remove_add_info_\"]');\n        button.hidden = true;\n    } else {\n        let buttons = document.querySelectorAll('[id^=\"id_remove_add_info_\"]');\n        buttons.forEach(button => {\n            button.hidden = false;\n        });\n    }\n};\n\n\n/**\n * @param {boolean} isNew\n */\nasync function addAdditionalInfo(isNew) {\n    counterInfo = counterInfo + 1;\n    let infoParent = document.querySelector('#add_info_0');\n    let info = infoParent.cloneNode(true);\n    info.setAttribute('id', 'add_info_' + counterInfo);\n\n    // Header\n    info.querySelector('#course_addinfo_header_0')\n        .setAttribute('id', 'course_addinfo_header_' + counterInfo);\n\n    info.querySelector('[href=\"#collapse_addinfo_header_0\"]').innerText =\n        await getString('field', 'format_udehauthoring')\n        + ' '\n        + (document.querySelectorAll('[aria-controls^=\"collapse_addinfo_header_\"]').length + 1);\n    info.querySelector('[href=\"#collapse_addinfo_header_0\"]')\n        .setAttribute('aria-controls', 'collapse_addinfo_header_' + counterInfo);\n    info.querySelector('[href=\"#collapse_addinfo_header_0\"]')\n        .setAttribute('href', '#collapse_addinfo_header_' + counterInfo);\n\n    info.querySelector('#collapse_addinfo_header_0')\n        .setAttribute('id', 'collapse_addinfo_header_' + counterInfo);\n\n    info.querySelector('#course_addinfo_0')\n        .setAttribute('id', 'course_addinfo_' + counterInfo);\n\n    if (info.querySelector('[name=\"add_info_0_id_value\"]')) {\n        info.querySelector('[name=\"add_info_0_id_value\"]')\n            .setAttribute('name', 'add_info_' + counterInfo + '_id_value');\n        info.querySelector('[name=\"add_info_' + counterInfo + '_id_value\"]').setAttribute('value', '');\n        info.querySelector('[name=\"add_info_' + counterInfo + '_id_value\"]').value = '';\n    }\n\n    // Title\n    let title = info.querySelector('#fitem_id_add_info_title_0');\n\n    title.setAttribute('id', 'fitem_id_add_info_title_' + counterInfo);\n\n    title.querySelector('[for=\"id_add_info_title_0\"]')\n        .setAttribute('for', 'id_add_info_title_' + counterInfo);\n    title.querySelector('#id_add_info_title_0')\n        .setAttribute('name', 'add_info_title_' + counterInfo);\n    title.querySelector('#id_add_info_title_0').value = '';\n    title.querySelector('#id_add_info_title_0')\n        .setAttribute('id', 'id_add_info_title_' + counterInfo);\n    title.querySelector('#id_error_add_info_title_0')\n        .setAttribute('id', 'id_error_add_info_title_' + counterInfo);\n\n\n    setEditorAfterCloning(info, 'content', 'add_info', counterInfo, null, isNew);\n\n    // Delete button\n    setDeleteButton(info, 'remove_add_info', counterInfo);\n\n    let container = document.querySelector('#displayable-form-additional-information-container');\n    container.insertBefore(info, document.querySelector('#addinfo-add-container'));\n\n    if (isNew) {\n        handleNewAccordion('#course_addinfo_header_', counterInfo);\n        await handleEditor(counterInfo);\n    }\n}\n\nconst handleEditor = async(addInfoIndex) => {\n    window.$.ajax(\n        {\n            type: \"POST\",\n            url: \"../handlers/ajax_editor_handler.php\",\n            data: {\n                id: document.querySelector(\"#udeh-form\").querySelector('[name = \"course_id\"]').value,\n                elementId: 'id_add_info_content_' + addInfoIndex,\n                text: ''\n            },\n            success: function(response) {\n                let draftIdElm = document.querySelector('#add_info_' + addInfoIndex)\n                    .querySelector('[name = \"add_info_content_' + addInfoIndex + '[itemid]\"]');\n                initEditor(\n                    response,\n                    draftIdElm\n                );\n            },\n            error: async function(e) {\n                window.console.log(e);\n            }\n        });\n};"],"names":["document","getElementById","addEventListener","async","event","target","nodeName","parentNode","element","id","includes","hidden","substring","lastIndexOf","index","querySelector","remove","dataset","changed","removeAdditionalInfo","disableAddInfoDeleteButton","updateExistingHeaders","stopImmediatePropagation","addAdditionalInfo","counterInfo","informations","length","information","i","indexOf","setAttribute","value","title","content","handleEditor","headers","querySelectorAll","Array","from","header","innerText","forEach","button","isNew","info","cloneNode","insertBefore","window","$","ajax","type","url","data","elementId","addInfoIndex","text","success","response","draftIdElm","error","e","console","log"],"mappings":"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"}