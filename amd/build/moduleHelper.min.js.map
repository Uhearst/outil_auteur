{"version":3,"file":"moduleHelper.min.js","sources":["../src/moduleHelper.js"],"sourcesContent":["import {\n    buildHiddenInput,\n    initEditor,\n    prepareActionButton,\n    removeTinyEditor,\n    setDeleteButton,\n    setEditorAfterCloning,\n    updateEditorAndLabel\n} from \"./utils\";\nimport {get_string as getString} from 'core/str';\nimport {handleAccordions, handleNewAccordion, initAccordionsAfterFillingForm} from \"./accordionHandler\";\n\nconst editorFields = ['title', 'question', 'description'];\nlet counterModules = 0;\n\n/**\n * @param {boolean} fromBtnClick\n */\nasync function addModule(fromBtnClick) {\n    counterModules = counterModules + 1;\n    let moduleParent = document.querySelector('#row_course_module_container_0');\n    let module = moduleParent.cloneNode(true);\n    module.setAttribute('id', 'row_course_module_container_' + counterModules);\n\n    // Header\n    module.querySelector('#course_module_header_0').setAttribute('id', 'course_module_header_' + counterModules);\n\n    module.querySelector('#section_isvisible_0').setAttribute('name', 'section_isvisible_' + counterModules);\n    module.querySelector('#section_isvisible_0').setAttribute('id', 'section_isvisible_' + counterModules);\n    module.querySelector('[for=\"section_isvisible_0\"]').setAttribute('for', 'section_isvisible_' + counterModules);\n\n    module.querySelector('[href=\"#collapse_module_header_0\"]').innerText =\n        await getString('section', 'format_udehauthoring') + ' ' + (counterModules + 1);\n    module.querySelector('[href=\"#collapse_module_header_0\"]')\n        .setAttribute('aria-controls', 'collapse_module_header_' + counterModules);\n    module.querySelector('[href=\"#collapse_module_header_0\"]')\n        .setAttribute('href', '#collapse_module_header_' + counterModules);\n\n    module.querySelector('#collapse_module_header_0')\n        .setAttribute('id', 'collapse_module_header_' + counterModules);\n\n    module.querySelector('#course_module_0').setAttribute('id', 'course_module_' + counterModules);\n    if (module.querySelector('[name=\"section_0_id_value\"]')) {\n        module.querySelector('[name=\"section_0_id_value\"]').setAttribute('value', '');\n        module.querySelector('[name=\"section_0_id_value\"]').setAttribute(\n            'name', 'section_' + counterModules + '_id_value');\n    }\n\n    // Content\n    editorFields.forEach(editorField => {\n        setEditorAfterCloning(module,\n            editorField,\n            'section',\n            counterModules,\n            null,\n            fromBtnClick\n        );\n    });\n\n    // Delete button\n    setDeleteButton(module, 'remove_module', counterModules);\n\n    let container = document.querySelector('#displayable-form-sections-container');\n    container.insertBefore(module, document.querySelector('#section-add-container'));\n\n    await updateAddModuleButton();\n    disableModuleDeleteButton();\n\n    if (fromBtnClick) {\n        handleNewAccordion('#course_module_header_', counterModules);\n        await handleEditor(counterModules);\n    }\n}\n\nconst handleEditor = async(counter) => {\n    editorFields.forEach(editorField => {\n        window.$.ajax(\n            {\n                type: \"POST\",\n                url: \"../handlers/ajax_editor_handler.php\",\n                data: {\n                    id: document.querySelector(\"#udeh-form\").querySelector('[name = \"course_id\"]').value,\n                    elementId: 'id_section_' + editorField + '_' + counter,\n                    text: ''\n                },\n                success: function(response) {\n                    let draftIdElm = document.querySelector('#row_course_module_container_' + counter)\n                        .querySelector('[name = \"section_' + editorField + '_' + counter + '[itemid]\"]');\n                    initEditor(\n                        response,\n                        draftIdElm\n                    );\n                },\n                error: async function(e) {\n                    window.console.log(e);\n                }\n            });\n    });\n};\n\n/**\n * @param {string} index\n */\nasync function removeModule(index) {\n    let module = document.querySelector('#row_course_module_container_' + index);\n    for (const editorField of editorFields) {\n        await removeTinyEditor('id_section_' + editorField + '_' + index);\n    }\n    module.remove();\n    await updateExistingModules(index);\n    await updateAddModuleButton();\n    disableModuleDeleteButton();\n    updateRemoveModuleButton();\n    counterModules = counterModules - 1;\n}\n\n/**\n *\n */\nfunction disableModuleDeleteButton() {\n    let modules = document.querySelectorAll('[id^=\"row_course_module_container_\"]');\n    if (modules.length === 1) {\n        let button = document.getElementById('id_remove_module_0');\n        button.hidden = true;\n    } else {\n        let buttons = document.querySelectorAll('[id^=\"id_remove_module\"]');\n        buttons.forEach(button => {\n            button.hidden = false;\n        });\n    }\n}\n\n/**\n *\n */\nasync function updateAddModuleButton() {\n    let x = document.querySelectorAll('[id^=\"row_course_module_container_\"]');\n    let addModuleButtonContainer = document.getElementById('section-add-container');\n    let addModuleButtonText = addModuleButtonContainer.querySelector('.add-text');\n    addModuleButtonText.innerHTML = await getString('section', 'format_udehauthoring') + ' ' + (x.length + 1);\n}\n\n/**\n *\n */\nfunction updateRemoveModuleButton() {\n    let buttons = document.querySelectorAll('[id^=\"fitem_id_remove_module_\"]');\n    buttons.forEach(function(button, index) {\n        button.setAttribute('id', 'fitem_id_remove_module_' + index);\n        let buttonElm = button.querySelector('[type=\"button\"]');\n        buttonElm.setAttribute('name', 'remove_module_' + index);\n        buttonElm.setAttribute('id', 'id_remove_module_' + index);\n    });\n}\n\n/**\n * @param {string} index\n */\nasync function updateExistingModules(index) {\n    let modules = document.querySelectorAll('[id^=\"row_course_module_container_\"]');\n    for (const module of modules) {\n        if (parseInt(module.id.substring(module.id.lastIndexOf('_') + 1)) > parseInt(index)) {\n            let currentIndex = parseInt(module.id.substring(module.id.lastIndexOf('_') + 1));\n            module.setAttribute('id', 'row_course_module_container_' + (currentIndex - 1));\n\n            let header = module.querySelector('.accordion-header');\n            header.setAttribute('id', 'course_module_header_' + (currentIndex - 1));\n\n            header.querySelector('[data-toggle=\"collapse\"]')\n                .setAttribute('href', '#collapse_module_' + (currentIndex - 1));\n\n            header.querySelector('[data-toggle=\"collapse\"]')\n                .setAttribute('aria-controls', 'collapse_module_' + (currentIndex - 1));\n\n            header.querySelector('[data-toggle=\"collapse\"]').innerHTML =\n                await getString('section', 'format_udehauthoring') + ' ' + (currentIndex);\n\n            header.querySelector('#section_isvisible_' + currentIndex)\n                .setAttribute('name', 'section_isvisible_' + (currentIndex - 1));\n\n            header.querySelector('#section_isvisible_' + currentIndex)\n                .setAttribute('id', 'section_isvisible_' + (currentIndex - 1));\n\n            let collapsible = module.querySelector('.collapse');\n            collapsible.setAttribute('id', 'collapse_module_' + (currentIndex - 1));\n            collapsible.firstElementChild.setAttribute('id', 'course_module_content_' + (currentIndex - 1));\n            module.querySelector('[name=\"section_' + currentIndex + '_id_value\"]')\n                .setAttribute('name', 'section_' + (currentIndex - 1) + '_id_value');\n            await updateEditorAndLabel(module, currentIndex, 'title', 'section');\n            await updateEditorAndLabel(module, currentIndex, 'question', 'section');\n            await updateEditorAndLabel(module, currentIndex, 'description', 'section');\n            await handleEditor((currentIndex - 1));\n        }\n    }\n}\n\n/**\n *\n */\nexport function initModules() {\n    const formContainer = document.getElementById('form_container');\n    let addButton = document.querySelector('#id_add_module');\n    formContainer.addEventListener('click', async event => {\n        const isButton = event.target.nodeName === 'BUTTON'\n            || (event.target.nodeName === 'I' && event.target.parentNode && event.target.parentNode.nodeName === 'BUTTON');\n        if (!isButton) {\n            return;\n        } else {\n            let element = null;\n            if (event.target.nodeName === 'I') {\n                element = event.target.parentNode;\n            } else {\n                element = event.target;\n            }\n            if (element && element.id.includes('module') && element.hidden === false) {\n                if (element.id.includes('remove')) {\n                    let id = element.id.substring(element.id.lastIndexOf('_') + 1);\n                    await removeModule(id);\n                    document.getElementById('udeh-form').dataset.changed = 'true';\n                    event.stopImmediatePropagation();\n                }\n            } else {\n                return;\n            }\n        }\n    });\n\n    addButton.addEventListener('click', async event => {\n        const isButton = event.target.nodeName === 'BUTTON'\n            || (event.target.nodeName === 'I' && event.target.parentNode && event.target.parentNode.nodeName === 'BUTTON');\n        if (!isButton) {\n            return;\n        } else {\n            event.stopImmediatePropagation();\n            let element = null;\n            if (event.target.nodeName === 'I') {\n                element = event.target.parentNode;\n            } else {\n                element = event.target;\n            }\n            if (element && element.id.includes('module') && element.hidden === false) {\n                await addModule(true);\n                document.getElementById('udeh-form').dataset.changed = 'true';\n            } else {\n                return;\n            }\n        }\n    });\n    let addingButtonsContainer = document.\n        querySelectorAll(\"[class='col-md-9 form-inline align-items-start felement']\");\n    if (addingButtonsContainer) {\n        addingButtonsContainer.forEach(function(addingButtonContainer) {\n            if (addingButtonContainer.dataset.fieldtype === 'button') {\n                addingButtonContainer.removeAttribute('class');\n                let childNodes = addingButtonContainer.childNodes;\n                childNodes.forEach(child => {\n                    if (child.type && child.type === 'button') {\n                        child.classList.remove('btn-secondary');\n                    }\n                });\n            }\n\n        });\n    }\n    let addingButtons = document.querySelectorAll(\"[class*='add_action_button']\");\n    if (addingButtons) {\n        addingButtons.forEach(function(addingButton) {\n            let childNodes = addingButton.childNodes;\n            childNodes.forEach(child => {\n                child.removeAttribute('class');\n            });\n        });\n    }\n    disableModuleDeleteButton();\n}\n\n/**\n * @param {array} modules\n */\nexport async function fillFormModules(modules) {\n    for (const module of modules) {\n        const i = modules.indexOf(module);\n        if (i === 0) {\n            // Editors value for index 0 are set in the course_plan to avoid racing conditions\n            buildHiddenInput(module.id, i, 'fitem_id_section_title_0', 'section_');\n            document.querySelector('#section_isvisible_0').checked = module.isvisiblepreview === '1';\n            document.querySelector('[name = \"section_0_id_value\"]').setAttribute('value', module.id);\n        } else {\n            if (document.getElementById('id_section_title_' + i) === null) {\n                await addModule(false);\n            }\n            document.querySelector('#section_isvisible_' + i).checked = module.isvisiblepreview === '1';\n            editorFields.forEach(editorField => {\n                document.querySelector('#id_section_' + editorField + '_' + i).value = module[editorField];\n            });\n            document.querySelector('[name = \"section_' + i + '_id_value\"]').setAttribute('value', module.id);\n            await handleEditor(i);\n        }\n    }\n    prepareActionButton([\n        {type: 0, id: 'module_0'},\n        {type: 1, id: 'module'}]);\n    disableModuleDeleteButton();\n    initAccordionsAfterFillingForm();\n    handleAccordions();\n    // prepareAccordions('row_course_module_container_');\n}\n\n"],"names":["modules","module","i","indexOf","id","document","querySelector","checked","isvisiblepreview","setAttribute","getElementById","addModule","editorFields","forEach","editorField","value","handleEditor","type","disableModuleDeleteButton","formContainer","addButton","addEventListener","async","event","target","nodeName","parentNode","element","includes","hidden","substring","lastIndexOf","index","remove","querySelectorAll","parseInt","currentIndex","header","innerHTML","collapsible","firstElementChild","updateExistingModules","updateAddModuleButton","button","buttonElm","counterModules","removeModule","dataset","changed","stopImmediatePropagation","addingButtonsContainer","addingButtonContainer","fieldtype","removeAttribute","childNodes","child","classList","addingButtons","addingButton","fromBtnClick","cloneNode","innerText","insertBefore","window","$","ajax","url","data","elementId","counter","text","success","response","draftIdElm","error","e","console","log","length","x"],"mappings":"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"}